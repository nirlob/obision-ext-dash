name: Build and Release DEB Package

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y devscripts equivs glib-2.0-dev gnome-shell-common
        sudo mk-build-deps -i -r -t "apt-get -y --no-install-recommends" debian/control
      
    - name: Build DEB package
      run: |
        dpkg-buildpackage -us -uc -b
        mkdir -p builddir
        mv ../gnome-shell-extension-obision-dash_*.deb builddir/obision-ext-dash.deb
        
    - name: Verify DEB exists
      run: |
        if [ ! -f builddir/obision-ext-dash.deb ]; then
          echo "ERROR: DEB file not found!"
          echo "Contents of builddir:"
          ls -la builddir/ || echo "builddir not found"
          echo "Contents of parent dir:"
          ls -la ../
          exit 1
        fi
        echo "✅ DEB file found:"
        ls -lh builddir/obision-ext-dash.deb
      
    - name: Create Release and Upload DEB
      uses: softprops/action-gh-release@v1
      with:
        files: builddir/obision-ext-dash.deb
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload to obision-packages repository
      env:
        DEPLOY_KEY: ${{ secrets.OBISION_PACKAGES_DEPLOY_KEY }}
      run: |
        # Extract version from tag
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "Version: $VERSION"
        
        # Configure git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Setup SSH key for obision-packages repo
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        
        # Clone obision-packages repository
        cd ..
        git clone git@github.com:nirlob/obision-packages.git
        cd obision-packages
        
        # Create packages directory if it doesn't exist
        mkdir -p packages
        
        # Copy DEB with versioned name
        cp ../obision-ext-dash/builddir/obision-ext-dash.deb "packages/obision-ext-dash_${VERSION}.deb"
        
        # Also copy as latest
        cp ../obision-ext-dash/builddir/obision-ext-dash.deb packages/obision-ext-dash-latest.deb
        
        echo "✅ Copied DEB files to obision-packages"
        
        # Update releases.json
        RELEASE_DATE=$(date -u +"%Y-%m-%d")
        
        # Create releases.json if it doesn't exist
        if [ ! -f releases.json ]; then
          echo '{"packages": []}' > releases.json
        fi
        
        # Update releases.json using jq
        jq --arg version "$VERSION" \
           --arg date "$RELEASE_DATE" \
           --arg url "https://github.com/nirlob/obision-packages/raw/main/packages/obision-ext-dash_${VERSION}.deb" \
           '.packages |= map(select(.name != "obision-ext-dash")) + [{
             "name": "obision-ext-dash",
             "version": $version,
             "date": $date,
             "url": $url,
             "description": "GNOME Shell 48 extension that provides a customizable dash/taskbar panel"
           }] | sort_by(.name)' releases.json > releases.json.tmp
        
        mv releases.json.tmp releases.json
        
        echo "✅ Updated releases.json"
        
        # Generate Packages file for APT repository
        dpkg-scanpackages packages /dev/null > Packages
        gzip -k -f Packages
        
        echo "✅ Updated Packages file"
        
        # Commit and push
        git add packages/ releases.json Packages Packages.gz
        git commit -m "Add obision-ext-dash ${VERSION}"
        git push origin main
        
        echo "✅ Pushed changes to obision-packages"
