name: Build and Release DEB Package

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y devscripts equivs glib-2.0-dev gnome-shell-common
        sudo mk-build-deps -i -r -t "apt-get -y --no-install-recommends" debian/control
      
    - name: Build DEB package
      run: |
        dpkg-buildpackage -us -uc -b
        mkdir -p builddir
        mv ../gnome-shell-extension-obision-dash_*.deb builddir/obision-ext-dash.deb
        
    - name: Verify DEB exists
      run: |
        if [ ! -f builddir/obision-ext-dash.deb ]; then
          echo "ERROR: DEB file not found!"
          echo "Contents of builddir:"
          ls -la builddir/ || echo "builddir not found"
          echo "Contents of parent dir:"
          ls -la ../
          exit 1
        fi
        echo "✅ DEB file found:"
        ls -lh builddir/obision-ext-dash.deb
      
    - name: Create Release and Upload DEB
      uses: softprops/action-gh-release@v1
      with:
        files: builddir/obision-ext-dash.deb
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload to obision-packages repository
      env:
        DEPLOY_KEY: ${{ secrets.OBISION_PACKAGES_DEPLOY_KEY }}
      run: |
        # Extract version from tag
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "Version: $VERSION"
        
        # Configure git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Setup SSH key for obision-packages repo
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        
        # Clone obision-packages repository
        cd ..
        git clone git@github.com:nirlob/obision-packages.git
        cd obision-packages
        
        # Create debs directory if it doesn't exist
        mkdir -p debs
        
        # Copy DEB with versioned name
        cp ../obision-ext-dash/builddir/obision-ext-dash.deb "debs/obision-ext-dash_${VERSION}_all.deb"
        
        echo "✅ Copied DEB file to obision-packages/debs"
        
        # Regenerate Packages file
        dpkg-scanpackages --multiversion debs > Packages
        gzip -k -f Packages
        
        echo "✅ Updated Packages file"
        
        # Generate Release file with updated hashes
        cat > Release << EOF
Origin: Obision
Label: Obision Packages
Suite: stable
Codename: stable
Architectures: all amd64 arm64
Components: main
Description: Obision APT Repository
Date: $(date -Ru)
EOF
        
        # Add MD5Sum
        echo "MD5Sum:" >> Release
        md5sum Packages | awk '{print " " $1, $(NF-1), $NF}' >> Release
        md5sum Packages.gz | awk '{print " " $1, $(NF-1), $NF}' >> Release
        
        # Add SHA1
        echo "SHA1:" >> Release
        sha1sum Packages | awk '{print " " $1, $(NF-1), $NF}' >> Release
        sha1sum Packages.gz | awk '{print " " $1, $(NF-1), $NF}' >> Release
        
        # Add SHA256
        echo "SHA256:" >> Release
        sha256sum Packages | awk '{print " " $1, $(NF-1), $NF}' >> Release
        sha256sum Packages.gz | awk '{print " " $1, $(NF-1), $NF}' >> Release
        
        echo "✅ Updated Release file"
        
        # Commit and push
        git add -A debs/
        git add Packages Packages.gz Release
        git commit -m "Add obision-ext-dash ${VERSION}"
        git push origin master
        
        echo "✅ Pushed changes to obision-packages"
